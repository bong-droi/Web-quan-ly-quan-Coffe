{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-clock"></i> {{ title }}</h4>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label">{{ form.name.label }} <span class="text-danger">*</span></label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <div class="text-danger small">{{ form.name.errors }}</div>
                            {% endif %}
                            <small class="text-muted">Ví dụ: Ca sáng, Ca chiều, Ca tối</small>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.start_time.label }} <span class="text-danger">*</span></label>
                                {{ form.start_time }}
                                {% if form.start_time.errors %}
                                    <div class="text-danger small">{{ form.start_time.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.end_time.label }} <span class="text-danger">*</span></label>
                                {{ form.end_time }}
                                {% if form.end_time.errors %}
                                    <div class="text-danger small">{{ form.end_time.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.capacity.label }} <span class="text-danger">*</span></label>
                                {{ form.capacity }}
                                {% if form.capacity.errors %}
                                    <div class="text-danger small">{{ form.capacity.errors }}</div>
                                {% endif %}
                                <small class="text-muted">Số lượng nhân viên cần cho ca này</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.date.label }}</label>
                                {{ form.date }}
                                {% if form.date.errors %}
                                    <div class="text-danger small">{{ form.date.errors }}</div>
                                {% endif %}
                                <small class="text-muted">Để trống nếu ca lặp lại</small>
                            </div>
                        </div>

                        <div id="shiftPreview" class="alert alert-info" style="display:none;">
                            <h6>Xem trước:</h6>
                            <p class="mb-0">
                                <strong>Ca:</strong> <span id="previewName"></span><br>
                                <strong>Thời gian:</strong> <span id="previewTime"></span><br>
                                <strong>Số giờ:</strong> <span id="previewHours"></span> giờ<br>
                                <strong>Số người:</strong> <span id="previewCapacity"></span> nhân viên
                            </p>
                        </div>

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'shifts:shift_list' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Hủy
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Lưu ca làm việc
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const nameInput = document.querySelector('input[name="name"]');
    const startTimeInput = document.querySelector('input[name="start_time"]');
    const endTimeInput = document.querySelector('input[name="end_time"]');
    const capacityInput = document.querySelector('input[name="capacity"]');
    const preview = document.getElementById('shiftPreview');

    function updatePreview() {
        const name = nameInput.value;
        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;
        const capacity = capacityInput.value;

        if (name && startTime && endTime) {
            document.getElementById('previewName').textContent = name;
            document.getElementById('previewTime').textContent = `${startTime} - ${endTime}`;
            
            // Calculate hours
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            let hours = (end - start) / (1000 * 60 * 60);
            if (hours < 0) hours += 24; // Handle overnight shifts
            document.getElementById('previewHours').textContent = hours.toFixed(1);
            
            document.getElementById('previewCapacity').textContent = capacity || '?';
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }

    nameInput.addEventListener('input', updatePreview);
    startTimeInput.addEventListener('change', updatePreview);
    endTimeInput.addEventListener('change', updatePreview);
    capacityInput.addEventListener('input', updatePreview);

    // Initial preview if editing
    updatePreview();
});
</script>
{% endblock %}