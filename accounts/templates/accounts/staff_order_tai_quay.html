{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Order t·∫°i qu·∫ßy | Nh√¢n vi√™n</title>
  <link rel="stylesheet" href="{% static 'accounts/css/dashboard.css' %}">
  <link rel="stylesheet" href="{% static 'menu/css/menu.css' %}">
  <style>
  /* M·ªü r·ªông v√πng n·ªôi dung cho√°n g·∫ßn h·∫øt m√†n h√¨nh */
  .dash-main{
    max-width: none;
    margin: 0;
    padding: 24px 40px 40px;
  }

  .wrap{margin:0}
  .grid{
    display:grid;
    grid-template-columns: minmax(0, 1.15fr) minmax(0, .85fr);
    gap:24px;
  }
  .card{
    background:#fff;
    border:1px solid rgba(0,0,0,.05);
    border-radius:22px;
    box-shadow:0 18px 50px rgba(0,0,0,.12);
  }
  .card h2{
    margin:0;
    padding:18px 22px;
    border-bottom:1px solid #f0eee9;
    font-size:20px;
  }
  .card .content{padding:18px 22px}

  .toolbar{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:16px;
    align-items:center;
  }
  .toolbar select{
    padding:10px 12px;
    border:1px solid #e6e2dc;
    border-radius:12px;
    min-width:160px;
    background:#fff;
  }
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #f0eee9;padding:10px;text-align:left}
  .right{text-align:right}
  .muted{color:#777}
  .btn{
    padding:10px 14px;
    border-radius:12px;
    border:1px solid #d6d3d1;
    background:#111;
    color:#fff;
    cursor:pointer;
  }
  .ghost{
    background:#fff7ee;
    color:#2a160f;
    border-color:#e6e2dc;
  }
  .card .pic{
    width:100%;
    height:160px;
    border-radius:16px;
    overflow:hidden;
    background:#faf7f2;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .card .pic img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .tabs{display:flex;gap:8px;margin:0 0 12px}
  .tab{
    padding:8px 14px;
    border:1px solid #e6e2dc;
    border-radius:10px;
    background:#fff7ee;
    cursor:pointer;
  }
  .tab.active{
    background: linear-gradient(180deg, #d3925d, #b96b33);
    color:#2a160f;
  }

  /* Modal message */
  .modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.45);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:50;
  }
  .modal{
    background:#fff;
    border-radius:16px;
    box-shadow:0 20px 60px rgba(0,0,0,.35);
    width:min(420px,92vw);
    padding:18px;
    border:1px solid rgba(0,0,0,.06);
  }
  .modal h3{margin:0 0 6px}
  .modal p{margin:0 0 14px;color:#444}
  .modal .row{display:flex;gap:10px;justify-content:flex-end}
  </style>
</head>
<body>
  <!-- Header l·ªõn ‚ÄúDashboard Nh√¢n vi√™n / ƒêƒÉng xu·∫•t‚Äù l·∫•y t·ª´ layout chung, KH√îNG th√™m logo ph·ª• ·ªü ƒë√¢y -->

  <main class="dash-main">
    <div class="wrap">
      <div class="grid">
        <!-- C·ªôt ch·ªçn m√≥n -->
        <div class="card">
          <h2>Ch·ªçn m√≥n</h2>
          <div class="content">
            <div class="toolbar">
<span>S·ªë b√†n:</span>
              <select id="tableSelect">
                <option value="">Ch·ªçn s·ªë b√†n</option>
                <option>B√†n 1</option>
                <option>B√†n 2</option>
                <option>B√†n 3</option>
              </select>
            </div>

            <div class="grid" style="grid-template-columns: repeat(3, minmax(0,1fr));gap:14px">
              {% for it in items %}
              <div class="card" style="border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08)">
                <div class="content">
                  <div class="pic">
                    {% if it.image %}
                      <img src="{{ it.image.url }}" alt="{{ it.name }}">
                    {% else %}
                      <span class="muted">‚òï</span>
                    {% endif %}
                  </div>
                  <div class="title" style="margin-top:10px;font-weight:600">{{ it.name }}</div>
                  <div class="muted" style="font-size:13px">
                    {% if it.category %}{{ it.category.name }}{% else %}Kh√¥ng ph√¢n lo·∫°i{% endif %}
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
                    <span style="font-weight:600">{{ it.price|floatformat:0 }}ƒë</span>
                    <button class="btn ghost add-btn" type="button"
                            data-id="{{ it.id }}"
                            data-name="{{ it.name|escapejs }}"
                            data-price="{{ it.price|floatformat:0 }}">
                      Th√™m
                    </button>
                  </div>
                </div>
              </div>
              {% empty %}
              <div class="muted">Ch∆∞a c√≥ m√≥n n√†o.</div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- C·ªôt gi·ªè h√†ng / ƒë∆°n ƒë√£ t·∫°o -->
        <div class="card">
          <div class="content">
            <div class="tabs">
              <button class="tab active" id="tabCart" onclick="showPanel('cart')">Gi·ªè h√†ng</button>
              <button class="tab" id="tabMy" onclick="showPanel('my')">ƒê∆°n ƒë√£ t·∫°o</button>
            </div>

            <div id="panelCart">
              <table>
                <thead>
                  <tr>
                    <th>M√≥n</th>
                    <th class="right">SL</th>
                    <th class="right">ƒê∆°n gi√°</th>
                    <th class="right">Th√†nh ti·ªÅn</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="cartBody">
                  <tr><td colspan="5" class="muted">Ch∆∞a c√≥ m√≥n.</td></tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="3" class="right"><b>T·ªïng</b></td>
                    <td class="right" id="totalCell">0</td>
                    <td></td>
                  </tr>
</tfoot>
              </table>

              <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
                <button class="btn ghost" type="button" onclick="clearCart()">X√≥a gi·ªè</button>
                <button id="placeBtn" class="btn" type="button" onclick="placeOrder()">ƒê·∫∑t h√†ng</button>
                <button class="btn ghost" type="button" onclick="cancelOrderPrompt()">H·ªßy ƒë∆°n</button>
              </div>
            </div>

            <div id="panelMy" style="display:none">
              <div id="myOrderBox" class="muted">Ch∆∞a c√≥ ƒë∆°n n√†o.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal th√¥ng b√°o -->
  <div id="msgOverlay" class="modal-overlay">
    <div class="modal">
      <h3 id="msgTitle">Th√¥ng b√°o</h3>
      <p id="msgText">N·ªôi dung</p>
      <div class="row">
        <button class="btn" type="button" onclick="hideMsg()">OK</button>
      </div>
    </div>
  </div>

  <script>
  var cart = [];

  function addItem(name, price, id){
    var ex = cart.find(function(i){ return i.name===name; });
    if(ex){ ex.qty += 1; }
    else { cart.push({ id:id, name:name, price:price, qty:1 }); }
    renderCart();
  }
  function removeItem(name){
    cart = cart.filter(function(i){ return i.name!==name; });
    renderCart();
  }
  function changeQty(name, delta){
    var it = cart.find(function(i){ return i.name===name; });
    if(!it) return;
    it.qty = Math.max(1, it.qty + delta);
    renderCart();
  }
  function clearCart(){ cart = []; renderCart(); }
  function money(n){ return new Intl.NumberFormat('vi-VN').format(n) + 'ƒë'; }

  function renderCart(){
    var body = document.getElementById('cartBody');
    var btn = document.getElementById('placeBtn');
    if(cart.length===0){
      body.innerHTML = '<tr><td colspan="5" class="muted">Ch∆∞a c√≥ m√≥n.</td></tr>';
      document.getElementById('totalCell').innerText='0';
      if(btn){ btn.style.display = 'none'; }
      return;
    }
    var html = '';
    var total = 0;
    cart.forEach(function(i){
      var line = i.price * i.qty; total += line;
      html += '<tr>'+
        '<td>'+i.name+'</td>'+
        '<td class="right">'+
          '<button class="ghost" style="padding:2px 8px" onclick="changeQty(\''+i.name+'\', -1)">-</button> '+i.qty+' '+
          '<button class="ghost" style="padding:2px 8px" onclick="changeQty(\''+i.name+'\', 1)">+</button>'+
        '</td>'+
        '<td class="right">'+money(i.price)+'</td>'+
        '<td class="right">'+money(line)+'</td>'+
        '<td><button class="ghost" onclick="removeItem(\''+i.name+'\')">X√≥a</button></td>'+
      '</tr>';
    });
    body.innerHTML = html;
    document.getElementById('totalCell').innerText = money(total);
    if(btn){ btn.style.display = ''; }
  }

  function showMsg(title, text){
    document.getElementById('msgTitle').innerText = title || 'Th√¥ng b√°o';
document.getElementById('msgText').innerText = text || '';
    document.getElementById('msgOverlay').style.display = 'flex';
  }
  function hideMsg(){ document.getElementById('msgOverlay').style.display = 'none'; }

  function placeOrder(){
    if(cart.length===0){
      showMsg('Thi·∫øu th√¥ng tin', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m√≥n.');
      return;
    }

    var t = document.getElementById('tableSelect').value.trim();
    if(!t){
      showMsg('Thi·∫øu s·ªë b√†n', 'Vui l√≤ng ch·ªçn s·ªë b√†n tr∆∞·ªõc khi ƒë·∫∑t.');
      return;
    }

    var csrfToken = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1];
    var payload = {
      order_type: 'offline',
      table_number: t,
      phone_number: '',
      delivery_address: '',
      items: cart.map(function(i){ return { menu_item_id: i.id, qty: i.qty }; })
    };

    fetch('{% url "create_order_from_customer" %}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
      body: JSON.stringify(payload)
    }).then(function(r){ return r.json(); }).then(function(res){
      if(res && res.ok){
        showMsg('Th√†nh c√¥ng', 'ƒê·∫∑t h√†ng th√†nh c√¥ng ‚úì');
        clearCart();
        window.latestOrderId = res.order_id;
      } else {
        showMsg('Kh√¥ng th·ªÉ ƒë·∫∑t h√†ng', (res && res.error ? res.error : 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
      }
    }).catch(function(e){
      showMsg('L·ªói k·∫øt n·ªëi', String(e));
    });
  }

  function cancelOrderPrompt(){
    if(!window.latestOrderId){
      showMsg('Ch∆∞a c√≥ ƒë∆°n', 'B·∫°n ch∆∞a t·∫°o ƒë∆°n n√†o ƒë·ªÉ h·ªßy.');
      return;
    }
    var reason = prompt('Nh·∫≠p l√Ω do h·ªßy ƒë∆°n:');
    if(reason===null){ return; }
    reason = String(reason||'').trim();
    if(!reason){
      showMsg('Thi·∫øu l√Ω do', 'Vui l√≤ng nh·∫≠p l√Ω do h·ªßy.');
      return;
    }
    var csrfToken = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1];
    fetch('/orders/api/'+window.latestOrderId+'/cancel/', {
      method:'POST',
      headers:{ 'X-CSRFToken': csrfToken, 'Content-Type':'application/x-www-form-urlencoded' },
      body: 'reason='+encodeURIComponent(reason)
    }).then(function(r){ return r.json(); }).then(function(res){
      if(res && res.ok){
        showMsg('ƒê√£ h·ªßy', 'ƒê∆°n ƒë√£ ƒë∆∞·ª£c h·ªßy.');
      } else {
        showMsg('Kh√¥ng th·ªÉ h·ªßy', (res && res.error ? res.error : 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
      }
    }).catch(function(e){
      showMsg('L·ªói k·∫øt n·ªëi', String(e));
    });
  }

  // n√∫t Th√™m m√≥n
  document.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('add-btn')){
      var id = parseInt(e.target.getAttribute('data-id'));
      var name = e.target.getAttribute('data-name');
      var price = parseFloat(e.target.getAttribute('data-price'));
      addItem(name, price, id);
    }
  });

  function showPanel(which){
    var cartP = document.getElementById('panelCart');
    var myP = document.getElementById('panelMy');
var tabCart = document.getElementById('tabCart');
    var tabMy = document.getElementById('tabMy');
    if(which==='my'){
      cartP.style.display='none';
      myP.style.display='block';
      tabCart.classList.remove('active');
      tabMy.classList.add('active');
      loadMyOrder();
    } else {
      cartP.style.display='block';
      myP.style.display='none';
      tabMy.classList.remove('active');
      tabCart.classList.add('active');
    }
  }

  function loadMyOrder(){
  fetch('/orders/api/my/').then(function(r){return r.json()}).then(function(res){
    var box = document.getElementById('myOrderBox');
    if(!(res && res.ok)){ 
      box.innerText='Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch ƒë∆°n.'; 
      return; 
    }

    var orders = res.orders || [];
    if(orders.length===0){ 
      box.innerText='Ch∆∞a c√≥ ƒë∆°n n√†o.'; 
      return; 
    }

    var totalOrders = orders.length;   // t·ªïng s·ªë ƒë∆°n ƒë·ªÉ ƒë√°nh s·ªë 1..N
    var html = '';

    orders.forEach(function(o, index){
      // üî• ƒê∆†N S·ªê TH·ª® T·ª∞: ƒë∆°n ƒë·∫ßu ti√™n t·∫°o = #1, ƒë∆°n sau = #2...
      var stt = totalOrders - index;

      html += '<div style="border:1px solid #f0eee9;border-radius:12px;padding:10px;margin-bottom:10px;background:#fff">';
      html += '<div><b>ƒê∆°n #'+ stt +'</b> - '+(o.order_type==='online'?'Online':'Offline')+' - '+o.created_at+'</div>';
      html += '<div class="muted">'+ (o.order_type==='online'
        ? ('ƒê·ªãa ch·ªâ: '+(o.delivery_address||'-')+' | SƒêT: '+(o.phone_number||'-'))
        : ('B√†n: '+(o.table_number||'-'))) +'</div>';

      html += '<table style="width:100%;border-collapse:collapse;margin-top:8px">'+
              '<thead><tr><th>M√≥n</th><th class="right">SL</th><th class="right">ƒê∆°n gi√°</th><th class="right">Th√†nh ti·ªÅn</th></tr></thead><tbody>';

      var total = 0;
      (o.items||[]).forEach(function(i){
        var qty   = i.qty || 1;
        var price = parseFloat(i.price);
        var line  = parseFloat(i.line);

        if (isNaN(price)) price = 0;
        if (isNaN(line))  line  = price * qty;

        total += line;

        html += '<tr>'+
                  '<td>'+i.name+'</td>'+
                  '<td class="right">'+qty+'</td>'+
                  '<td class="right">'+ money(price) +'</td>'+
                  '<td class="right">'+ money(line)  +'</td>'+
                '</tr>';
      });

      html += '</tbody><tfoot><tr>'+
                '<td colspan="3" class="right"><b>T·ªïng</b></td>'+
                '<td class="right">'+ money(total) +'</td>'+
              '</tr></tfoot></table>';

      if(o.status!=='processed' && o.status!=='canceled'){
        html += '<div style="margin-top:10px;text-align:right">'+
                  '<button class="btn ghost" type="button" onclick="cancelOrderPromptFor('+o.id+')">H·ªßy ƒë∆°n</button>'+
                '</div>';
      }
      if(o.status==='canceled'){
html += '<div class="muted" style="margin-top:6px">ƒê√£ h·ªßy: '+(o.cancel_reason||'-')+'</div>';
      }
      html += '</div>';
    });

    box.innerHTML = html;
  }).catch(function(){
    document.getElementById('myOrderBox').innerText='Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch ƒë∆°n.';
  });
}

  function cancelOrderPromptFor(id){
    var reason = prompt('Nh·∫≠p l√Ω do h·ªßy ƒë∆°n:');
    if(reason===null){ return; }
    reason = String(reason||'').trim();
    if(!reason){
      showMsg('Thi·∫øu l√Ω do', 'Vui l√≤ng nh·∫≠p l√Ω do h·ªßy.');
      return;
    }
    var csrfToken = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1];
    fetch('/orders/api/'+id+'/cancel/', {
      method:'POST',
      headers:{ 'X-CSRFToken': csrfToken, 'Content-Type':'application/x-www-form-urlencoded' },
      body: 'reason='+encodeURIComponent(reason)
    }).then(function(r){ return r.json() }).then(function(res){
      if(res && res.ok){
        loadMyOrder();
      } else {
        showMsg('Kh√¥ng th·ªÉ h·ªßy', (res && res.error ? res.error : 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
      }
    }).catch(function(e){
      showMsg('L·ªói k·∫øt n·ªëi', String(e));
    });
  }
  </script>
</body>
</html>